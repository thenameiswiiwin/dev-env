#!/usr/bin/env bash
# High-performance tmux session bootstrapper
# Optimized for single-window workflow with instant startup

# Enable strict mode for robustness
set -euo pipefail

# Skip for home directory - avoid unnecessary setup
if [[ "$(pwd)" == "$HOME" || "$(pwd)" == "$HOME/personal" ]]; then
  clear
  echo "No project-specific setup needed for home directory."
  return 0
fi

# Determine editor - respect user preferences with fast fallbacks
EDITOR=${EDITOR:-$(command -v nvim || command -v vim || command -v nano || echo "vim")}

# Fast git repo detection with early exit for non-git repos
if ! git rev-parse --is-inside-work-tree &>/dev/null; then
  # Not a git repository - minimal setup
  tmux rename-window -t 1 "edit" 2>/dev/null || true
  clear
  exec "$EDITOR" .
fi

# Git repo handling - optimized for speed
GIT_ROOT=$(git rev-parse --show-toplevel)
SESSION_NAME=$(basename "$GIT_ROOT" | tr . _ | tr ' ' _)
CURRENT_WINDOW=$(tmux display-message -p '#W')

# Rename window if needed (single operation)
if [[ "$CURRENT_WINDOW" == "$SESSION_NAME" || "$CURRENT_WINDOW" == "1" || "$CURRENT_WINDOW" == "main" ]]; then
  tmux rename-window -t 1 "edit" 2>/dev/null || true
fi

# Jump to git root and open editor (no additional windows)
cd "$GIT_ROOT" || {
  echo "Failed to change directory to $GIT_ROOT"
  return 1
}
clear
exec "$EDITOR" .
